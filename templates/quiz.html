{% extends "base.html" %}
{% block content %}
<div style="background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <a href="{{ url_for('student_dashboard') }}" style="text-decoration: none; color: #007bff; margin-right: 15px;">Dashboard</a>
        <a href="{{ url_for('list_course', course_id=topic.course.course_info.id) }}" style="text-decoration: none; color: #007bff;">Back to Course</a>
    </div>
</div>

<div style="padding: 20px;">
    {% if is_subtopic_quiz %}
        <h2>Subtopic Quiz: {{ subtopic.subtopic_name }}</h2>
        <h3 style="color: #666;">Topic: {{ topic.topic_name }}</h3>
    {% else %}
        <h2>Topic Quiz: {{ topic.topic_name }}</h2>
    {% endif %}

    <div id="quiz-container">
        {% for question in questions %}
        <div class="question-card" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>Question {{ loop.index }}: {{ question.question }}</h4>
            <div class="options" style="margin-left: 20px; margin-top: 10px;">
                <div class="option" style="margin-bottom: 10px;">
                    <input type="radio" id="q{{ question.id }}_A" name="q{{ question.id }}" value="A" class="quiz-option">
                    <label for="q{{ question.id }}_A">A) {{ question.option_a }}</label>
                </div>
                <div class="option" style="margin-bottom: 10px;">
                    <input type="radio" id="q{{ question.id }}_B" name="q{{ question.id }}" value="B" class="quiz-option">
                    <label for="q{{ question.id }}_B">B) {{ question.option_b }}</label>
                </div>
                <div class="option" style="margin-bottom: 10px;">
                    <input type="radio" id="q{{ question.id }}_C" name="q{{ question.id }}" value="C" class="quiz-option">
                    <label for="q{{ question.id }}_C">C) {{ question.option_c }}</label>
                </div>
                <div class="option" style="margin-bottom: 10px;">
                    <input type="radio" id="q{{ question.id }}_D" name="q{{ question.id }}" value="D" class="quiz-option">
                    <label for="q{{ question.id }}_D">D) {{ question.option_d }}</label>
                </div>
            </div>
            <div style="display: flex; align-items: start; gap: 10px; margin-top: 10px;">
                <div class="feedback" style="display: none; flex: 1; padding: 10px; border-radius: 4px;"></div>
                <button class="explanation-btn" style="display: none; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                    Show Explanation
                </button>
            </div>
            <div class="explanation-text" style="display: none; margin-top: 10px; padding: 10px; background-color: #e9ecef; border-radius: 4px;">
                description
            </div>
            <input type="hidden" class="correct-answer" value="{{ question.correct_answer }}">
        </div>
        {% endfor %}

        <button id="submit-quiz" style="display: none; width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px;">
            Submit Quiz
        </button>

        <div id="quiz-results" style="display: none; margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
            <h3>Quiz Results</h3>
            <p id="score-display"></p>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button id="retake-button" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Retake Quiz
                </button>
                
                {% if is_subtopic_quiz %}
                <form action="{{ url_for('recreate_quiz', topic_id=subtopic.id) }}?is_subtopic=true&subtopic_id={{ subtopic.id }}" method="POST" style="display: inline;">
                {% else %}
                <form action="{{ url_for('recreate_quiz', topic_id=topic.id) }}?is_subtopic=false" method="POST" style="display: inline;">
                {% endif %}
                    <button type="submit" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Recreate Quiz
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quizContainer = document.getElementById('quiz-container');
    const submitButton = document.getElementById('submit-quiz');
    const quizResults = document.getElementById('quiz-results');
    const retakeButton = document.getElementById('retake-button');
    const questions = document.querySelectorAll('.question-card');
    let quizSubmitted = false;

    // Load saved answers from localStorage if they exist
    const quizId = '{{ "subtopic_" + subtopic.id|string if is_subtopic_quiz else "topic_" + topic.id|string }}';
    const savedAnswers = JSON.parse(localStorage.getItem(`quiz_${quizId}_answers`)) || {};
    
    // Apply saved answers
    Object.entries(savedAnswers).forEach(([questionId, answer]) => {
        const radio = document.querySelector(`#q${questionId}_${answer}`);
        if (radio) {
            radio.checked = true;
        }
    });

    // Check if all questions are answered and show/hide submit button
    function updateSubmitButton() {
        if (quizSubmitted) return;
        
        const allAnswered = Array.from(questions).every(question => {
            const name = question.querySelector('input[type="radio"]').name;
            return document.querySelector(`input[name="${name}"]:checked`);
        });
        
        submitButton.style.display = allAnswered ? 'block' : 'none';
    }

    // Save answers to localStorage when they change
    quizContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('quiz-option')) {
            const questionId = e.target.name.replace('q', '');
            const answer = e.target.value;
            
            savedAnswers[questionId] = answer;
            localStorage.setItem(`quiz_${quizId}_answers`, JSON.stringify(savedAnswers));
            
            updateSubmitButton();
        }
    });

    // Handle quiz submission
    submitButton.addEventListener('click', function() {
        if (quizSubmitted) return;
        
        let correctCount = 0;
        const totalQuestions = questions.length;

        questions.forEach(question => {
            const selectedAnswer = question.querySelector('input[type="radio"]:checked').value;
            const correctAnswer = question.querySelector('.correct-answer').value;
            const feedbackDiv = question.querySelector('.feedback');
            const explanationBtn = question.querySelector('.explanation-btn');

            if (selectedAnswer === correctAnswer) {
                correctCount++;
                feedbackDiv.textContent = 'Correct!';
                feedbackDiv.style.backgroundColor = '#d4edda';
                feedbackDiv.style.color = '#155724';
            } else {
                feedbackDiv.textContent = `Incorrect. The correct answer was ${correctAnswer}.`;
                feedbackDiv.style.backgroundColor = '#f8d7da';
                feedbackDiv.style.color = '#721c24';
            }
            feedbackDiv.style.display = 'block';
            explanationBtn.style.display = 'block';
        });

        // Show results
        const scoreDisplay = document.getElementById('score-display');
        const percentage = (correctCount / totalQuestions) * 100;
        scoreDisplay.textContent = `You got ${correctCount} out of ${totalQuestions} questions correct! (${percentage.toFixed(1)}%)`;
        quizResults.style.display = 'block';

        // Disable all inputs and hide submit button
        quizContainer.querySelectorAll('input[type="radio"]').forEach(input => {
            input.disabled = true;
        });
        submitButton.style.display = 'none';
        
        // Clear saved answers
        localStorage.removeItem(`quiz_${quizId}_answers`);
        
        quizSubmitted = true;
    });

    // Handle explanation buttons
    document.querySelectorAll('.explanation-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const explanationText = this.parentElement.nextElementSibling;
            if (explanationText.style.display === 'none') {
                explanationText.style.display = 'block';
                this.textContent = 'Close Explanation';
            } else {
                explanationText.style.display = 'none';
                this.textContent = 'Show Explanation';
            }
        });
    });

    // Handle retake quiz
    if (retakeButton) {
        retakeButton.addEventListener('click', function() {
            // Reset all radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(input => {
                input.checked = false;
                input.disabled = false;
            });
            
            // Hide all feedback, explanation buttons, and explanation texts
            document.querySelectorAll('.feedback').forEach(div => {
                div.style.display = 'none';
            });
            document.querySelectorAll('.explanation-btn').forEach(btn => {
                btn.style.display = 'none';
                btn.textContent = 'Açıklamayı Göster';
            });
            document.querySelectorAll('.explanation-text').forEach(div => {
                div.style.display = 'none';
            });
            
            // Hide results and submit button
            document.getElementById('quiz-results').style.display = 'none';
            document.getElementById('submit-quiz').style.display = 'none';
            
            // Reset quiz state
            quizSubmitted = false;
            
            // Clear saved answers
            localStorage.removeItem(`quiz_${quizId}_answers`);
            
            // Scroll to top
            window.scrollTo(0, 0);
        });
    }

    // Initial check for submit button
    updateSubmitButton();
});
</script>
{% endblock %}