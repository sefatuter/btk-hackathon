{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
    <div class="processing-modal">
        <div class="loading-spinner"></div>
        <p class="processing-text">AI is processing</p>
    </div>
</div>

<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="d-flex justify-content-between align-items-center">
        <h1>Student Dashboard</h1>
        <a href="{{ url_for('student_dashboard') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </a>
    </div>

    <!-- Quick Links -->
    <div class="quick-links mb-4">
        <a href="{{ url_for('home') }}" class="btn btn-primary me-2">Home</a>
        <a href="{{ url_for('chatbot') }}" class="btn btn-success">Chatbot</a>
    </div>

    <!-- Chat Box -->
    <div class="chat-container mb-4">
        <!-- Chat Messages -->
        <div class="chat-box mb-3">
            {% set combined_history = historyUser + historyAI %}
            {% set sorted_history = combined_history | sort(attribute='timestamp') %}
            
            {% for message in sorted_history %}
            <div class="message {% if message.sender == 'user' %}user-message{% else %}ai-message{% endif %} chatbot-message">
                <div class="d-flex {% if message.sender == 'user' %}justify-content-end{% endif %}">  
                    <div class="message-content">
                        {% if message.text in ['```json\n{}\n```', '{}\n', '{}'] %}
                            <div class="error-message">Please Ask About University Courses.</div>
                        {% elif message.sender == 'ai' %}
                            <div class="success-message">Course Added Successfully.</div>
                            {% set course = json_to_table | selectattr("id", "equalto", message.course_id) | list | first %}
                            {% if course %}
                                <div>Course Code: {{ course.course_code }}</div>
                                <div>Course Name: {{ course.course_name }}</div>
                            {% else %}
                                <div>Course information not found.</div>
                            {% endif %}
                        {% else %}
                            {{ message.text }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Prompt Input Form -->
        <form method="POST" action="{{ url_for('student_dashboard') }}" class="prompt-form">
            <div class="input-group">
                <input type="text" 
                    id="user_question"
                    name="user_question" 
                    class="form-control" 
                    placeholder="Type your message here..."
                    required
                    autocomplete="off">
                <button type="submit" class="btn btn-primary student-dashboard-button">
                    Send
                </button>
            </div>
        </form>
    </div>

    <!-- Courses Table -->
    <div class="courses-section">
        <h2>University Courses</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in json_to_table %}
                    <tr>
                        <td>{{ course.course_code }}</td>
                        <td>{{ course.course_name }}</td>
                        <td>{{ course.description }}</td>
                        <td>
                            <a href="{{ url_for('list_course', course_id=course.id) }}" 
                               class="btn btn-sm btn-primary list-course-btn">List Course</a>
                            <form action="{{ url_for('delete_course', course_id=course.id) }}" 
                                  method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger">Delete Course</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const listButtons = document.querySelectorAll('.list-course-btn');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Function to remove overlay
    function removeOverlay() {
        loadingOverlay.classList.remove('active');
        document.body.classList.remove('loading-active');
    }

    // Add click handler to each button
    listButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show loading overlay
            loadingOverlay.classList.add('active');
            document.body.classList.add('loading-active');

            // Navigate to the course listing page after a slight delay
            setTimeout(() => {
                window.location.href = this.href;
            }, 500);
        });
    });

    // Clean up overlay on page load/reload
    removeOverlay();

    // Handle browser back/forward navigation
    window.addEventListener('pageshow', function(event) {
        // This triggers even when navigating from browser cache (back/forward)
        if (event.persisted) {
            removeOverlay();
        }
    });

    // Additional safety cleanup for other navigation scenarios
    window.addEventListener('popstate', function() {
        removeOverlay();
    });
});
</script>
{% endblock %}